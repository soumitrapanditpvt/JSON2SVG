name: SVG Conversion Workflow

on:
  push:
    branches:
      - main
    paths:
      - '**/*.json'  # Trigger the workflow for any .json file change in any directory

  pull_request:
    branches:
      - main
    paths:
      - '**/*.json'

jobs:
  build-and-convert:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Get list of modified JSON files using git log
      - name: Get modified JSON files
        id: get_files
        run: |
          MODIFIED_JSON_FILES=$(git log -m -1 --name-only --pretty="" -- '*.json')
          echo "Modified JSON files: $MODIFIED_JSON_FILES"
          
          # Write the output to an environment file for future use
          echo "json_files=$MODIFIED_JSON_FILES" >> $GITHUB_ENV

      # Step 3: Extract directories from the modified JSON files using a more robust approach
      - name: Get modified directories
        id: get_dirs
        run: |
          # Initialize an empty string to store modified folders
          MODIFIED_FOLDERS=""
          
          # Loop through each modified file and extract its directory
          for file in ${{ env.json_files }}; do
            # Append the directory name of the file to MODIFIED_FOLDERS
            folder=$(dirname "$file")
            MODIFIED_FOLDERS="$MODIFIED_FOLDERS $folder"
          done

          # Use tr to convert spaces to newlines, sort uniquely, and remove empty lines
          MODIFIED_FOLDERS=$(echo "$MODIFIED_FOLDERS" | tr ' ' '\n' | sort -u | sed '/^$/d')

          # Format the variable correctly to avoid newlines or special characters
          FORMATTED_FOLDERS=$(printf "%s" "$MODIFIED_FOLDERS" | tr '\n' ' ')
          
          echo "Modified directories: $FORMATTED_FOLDERS"
          echo "folders=$FORMATTED_FOLDERS" >> $GITHUB_ENV

      # Step 4: Build the Docker image
      - name: Build Docker image
        run: docker build -t floorplan_converter .

      # Step 5: Run the Docker container for each modified directory
      - name: Run conversion for each modified directory
        run: |
          for folder in ${{ env.folders }}; do
            echo "Processing folder: $folder"
            docker run --rm -v ${{ github.workspace }}/$folder:/usr/src/app/$folder floorplan_converter python main.py /usr/src/app/$folder
          done

      # Step 6: Commit and push changes (e.g., new SVG files) back to the repository
      - name: Commit and Push SVGs
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add **/*.svg
          git commit -m "Add generated SVG files"
          git push
